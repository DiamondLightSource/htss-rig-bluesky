
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Setup your own Bluesky Project &#8212; htss-rig-bluesky 0.1.dev114+gcc94eb76e documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=05bfc3fc"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to/own-bluesky-project';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://DiamondLightSource.github.io/htss-rig-bluesky/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../_static/dls-logo.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Run in a container" href="run-container.html" />
    <link rel="prev" title="Nest Plans" href="nesting.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/dls-logo.svg" class="logo__image only-light" alt=""/>
    <img src="../_static/dls-logo.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">htss-rig-bluesky</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/htss-rig-bluesky" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/htss-rig-bluesky" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/htss-rig-bluesky" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/htss-rig-bluesky" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contribute to the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-environment.html">Setup Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="nesting.html">Nest Plans</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Setup your own Bluesky Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="run-container.html">Run in a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="write-a-plan.html">Write a Plan</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../how-to.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Setup your own Bluesky Project</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="setup-your-own-bluesky-project">
<h1>Setup your own Bluesky Project<a class="headerlink" href="#setup-your-own-bluesky-project" title="Link to this heading">#</a></h1>
<p>While it is useful to play with real hardware, the limitations of availability and time may mean that developers wish to use simulated hardware.</p>
<p>This page, while strictly not related to the test rigs, gives step-by-step instructions to developers on how to setup their own Python project, install all of the relevant dependencies and import bluesky running against Diamond’s simulated hardware. It also introduces the <a class="reference external" href="https://github.com/diamondLightSource/python3-pip-skeleton">python skeleton</a> and general Python development environment tips to those unfamiliar. It also makes use of <a class="reference external" href="https://blueskyproject.io/ophyd-async">ophyd-async</a>, a new and improved version of <a class="reference external" href="https://blueskyproject.io/ophyd">Ophyd</a>, aimed at improving hardware-triggered scanning, that forms the bulk of Diamond’s contribution to the Bluesky collaboration.</p>
<section id="setting-up-a-new-project">
<h2>Setting up a new project<a class="headerlink" href="#setting-up-a-new-project" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For performance, it is recommended that you put your project somewhere on <code class="docutils literal notranslate"><span class="pre">/scratch</span></code> rather than your home directory, which will be very slow and fill up quickly!</p>
</div>
<p>The easiest way to setup a new project is to use the <a class="reference external" href="https://github.com/diamondLightSource/python3-pip-skeleton">python skeleton</a>, which includes a lot of the tooling etc. for free.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>python/3.11<span class="w">  </span><span class="c1"># Only required on DLS workstations</span>
python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>python3-pip-skeleton
<span class="nb">cd</span><span class="w"> </span>&lt;directory<span class="w"> </span>where<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>put<span class="w"> </span>your<span class="w"> </span>project&gt;
~/.local/bin/python3-pip-skeleton<span class="w"> </span>new<span class="w"> </span>--org<span class="w"> </span>DiamondLightSource<span class="w"> </span>&lt;name<span class="w"> </span>of<span class="w"> </span>project&gt;
</pre></div>
</div>
<p>We recommend development with Microsoft Visual Studio Code, although if you have your own IDE preference and want to set it up yourself, feel free to skip the rest of this section.
Otherwise:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>vscode<span class="w">  </span><span class="c1"># Only required for DLS workstations</span>
code<span class="w"> </span>&lt;your<span class="w"> </span>project<span class="w"> </span>directory&gt;
</pre></div>
</div>
<p>This will open a new vscode window. Access all commands via CTRL-SHIFT-P and search for “Create new terminal” to open an integrated terminal in the IDE.
You can either setup a <a class="reference external" href="https://docs.python.org/3/library/venv.html">Python virtual environment</a> or a <a class="reference external" href="https://epics-containers.github.io/main/user/tutorials/devcontainer.html">developer container</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Developer containers are not available on RHEL7!</p>
</div>
<p>For a virtual environment:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>&lt;your<span class="w"> </span>project&gt;
python3.11<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv<span class="w">  </span><span class="c1"># Create a new virtual env in a directory called &lt;your project&gt;/venv</span>
<span class="nb">source</span><span class="w"> </span>venv/bin/activate<span class="w">  </span><span class="c1"># Activate the venv for your terminal session</span>
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;.[dev]&#39;</span><span class="w">  </span><span class="c1"># Install your project and it&#39;s dependencies (including development/testing dependencies) into venv</span>
</pre></div>
</div>
<p>Finally, in vscode, press CTRL-SHIFT-P and search for “Python: Select Interpreter”, use this to tell vscode which Python executable you will be using. Point it to <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/venv/bin/python</span></code>.</p>
</section>
<section id="installing-libraries">
<h2>Installing Libraries<a class="headerlink" href="#installing-libraries" title="Link to this heading">#</a></h2>
<p>Open <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/pyproject.toml</span></code> and find the entry labelled <code class="docutils literal notranslate"><span class="pre">&quot;dependencies&quot;</span></code>, add a series Bluesky related libraries so it looks something like this:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;bluesky&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;ophyd-async&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;dls-dodal&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;pyepics&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;click&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Then run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;.[dev]&#39;</span><span class="w">  </span><span class="c1"># Install/update dependencies in venv</span>
</pre></div>
</div>
<p>This is a minimal set of libraries to get you started. One of them, <a class="reference external" href="https://github.com/DiamondLightSource/dodal">dodal</a>, includes the logic for controlling the DLS simulated AreaDetector and motors.</p>
<p>If you’ve followed along so far, your project should look something like this:</p>
<a class="reference internal image-reference" href="../_images/vscode-project.png"><img alt="Vscode project example" src="../_images/vscode-project.png" style="width: 800px;" />
</a>
</section>
<section id="building-an-example-application">
<h2>Building an Example Application<a class="headerlink" href="#building-an-example-application" title="Link to this heading">#</a></h2>
<p>Now to build a very simple application which replicates (some of) the GDA scan command. Here are its components:</p>
<a class="reference internal image-reference" href="../_images/bluesky-simple-app.png"><img alt="Bluesky simple application structure" src="../_images/bluesky-simple-app.png" style="width: 500px;" />
</a>
<ul class="simple">
<li><p><strong>CLI</strong>: The command line interface allows a user to type commands into a terminal to make the system do things.</p></li>
<li><p><strong>Bluesky Plans</strong>: Python functions that generate instructions for the bluesky to run (similar to live mode) or validate (similar to dummy mode)</p></li>
<li><p><strong>Ophyd Devices</strong>: Repository of objects representing hardware (simulated in this case) that can be looked up by name</p></li>
<li><p><strong>Bluesky Run Engine</strong>: Interpreter for plan instructions that then controls Ophyd devices</p></li>
</ul>
</section>
<section id="component-1-the-command-line-interface">
<h2>Component #1: The Command Line Interface<a class="headerlink" href="#component-1-the-command-line-interface" title="Link to this heading">#</a></h2>
<p>This part of the application simply takes the user input, turns it into a machine-readable model and passes it to the business logic (bluesky). It’s made using <a class="reference external" href="https://palletsprojects.com/p/click/">click</a>, a very developer-friendly CLI library that you installed in the dependencies section earlier:</p>
<p>Edit the file: <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/src/&lt;your</span> <span class="pre">project&gt;/__main__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">click</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>


<span class="c1"># Boilerplate to set up a group of click commands</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">invoke_without_command</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">version_option</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span> <span class="n">prog_name</span><span class="o">=</span><span class="s2">&quot;htss&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">pass_context</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple bluesky utility&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">invoked_subcommand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please run a command, run with --help for help&quot;</span><span class="p">)</span>


<span class="c1"># These decorators define the scan command and its arguments,</span>
<span class="c1"># including information displayed in any help message.</span>
<span class="c1"># This means the scan command is invoked via</span>
<span class="c1"># python -m &lt;project name&gt; motor start stop step detectors</span>
<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;motor&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;detectors&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span>
    <span class="n">motor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">detectors</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a scan</span>

<span class="sd">    MOTOR: Name of the motor to move</span>

<span class="sd">    START: Start position of the motor</span>

<span class="sd">    STOP: Final position of the motor</span>

<span class="sd">    STEP: Distance the motor moves at each step</span>

<span class="sd">    DETECTORS: Names of detectors that should acquire data at each point, separate</span>
<span class="sd">        by space if more than one</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># We have not yet implemented our scan logic, for now</span>
    <span class="c1"># just print out the parameters the user put in</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pretending to run a scan&quot;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;motor&quot;</span><span class="p">:</span> <span class="n">motor</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
            <span class="s2">&quot;detectors&quot;</span><span class="p">:</span> <span class="n">detectors</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="c1"># test with: python -m myblueskyproject</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>There is no scan logic yet, but you can now run some commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>myblueskyproject<span class="w"> </span>scan<span class="w"> </span>--help<span class="w">  </span><span class="c1"># Should print out a useful help message detailing how to use your scan command</span>
python<span class="w"> </span>-m<span class="w"> </span>myblueskyproject<span class="w"> </span>scan<span class="w"> </span>x<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">0</span>.1<span class="w"> </span>adsim<span class="w">  </span><span class="c1"># Won&#39;t run a scan yet, will just print out what it intends to do</span>
</pre></div>
</div>
</section>
<section id="component-2-the-ophyd-devices">
<h2>Component #2: The Ophyd Devices<a class="headerlink" href="#component-2-the-ophyd-devices" title="Link to this heading">#</a></h2>
<p>These will communicate with hardware via EPICS to run your scan. This tutorial targets the DLS simulated AreaDetector and motors, which can be run using the launcher.</p>
<p>The easiest way is:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>tlauncher
</pre></div>
</div>
<p>Then type <code class="docutils literal notranslate"><span class="pre">&quot;GDA</span> <span class="pre">AreaDetector</span> <span class="pre">Simulation&quot;</span></code> and press enter. Click “Start IOC” on the EDM screen that appears.</p>
<p>Once they are up and running, you can use Ophyd devices from dodal to control them. Create a new file <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/src/&lt;your</span> <span class="pre">project&gt;/devices.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dodal.adsim</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdSimDetector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd</span><span class="w"> </span><span class="kn">import</span> <span class="n">Device</span><span class="p">,</span> <span class="n">EpicsMotor</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DeviceRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to hold and retrieve all devices that the application may need</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_devices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Device</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_devices</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Device</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Give the user a device with the name supplied. If there</span>
<span class="sd">        is not device under that name, raise a KeyError</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the device</span>

<span class="sd">        Returns:</span>
<span class="sd">            Device: An Ophyd device representing some hardware</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize all devices and connect to IOCs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Simulated AreaDetector uses the workstation name</span>
        <span class="c1"># in its PVs</span>
        <span class="n">workstation_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create devices representing motor and detector PVs</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">AdSimDetector</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;adsim&quot;</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workstation_name</span><span class="si">}</span><span class="s2">-AD-SIM-01:&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Change this if you want the detector to write files somewhere else.</span>
        <span class="c1"># These two lines will make it write to /tmp/data/&lt;current year&gt;.</span>
        <span class="n">det</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">reg_root</span> <span class="o">=</span> <span class="s2">&quot;/tmp/data&quot;</span>
        <span class="n">det</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">write_path_template</span> <span class="o">=</span> <span class="s2">&quot;%Y&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;adsim&quot;</span><span class="p">:</span> <span class="n">det</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">EpicsMotor</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workstation_name</span><span class="si">}</span><span class="s2">-MO-SIM-01:M1&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">EpicsMotor</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workstation_name</span><span class="si">}</span><span class="s2">-MO-SIM-01:M2&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">EpicsMotor</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workstation_name</span><span class="si">}</span><span class="s2">-MO-SIM-01:M3&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">EpicsMotor</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workstation_name</span><span class="si">}</span><span class="s2">-MO-SIM-01:M4&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;load&quot;</span><span class="p">:</span> <span class="n">EpicsMotor</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;load&quot;</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workstation_name</span><span class="si">}</span><span class="s2">-MO-SIM-01:M5&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Make all devices check that their PVs actually exist</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">device</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
</pre></div>
</div>
<p>This is a simple class to hold and connect the devices to hardware, we can edit our cli to use it, open <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/src/&lt;your</span> <span class="pre">project&gt;/__main__.py</span></code> and add to the scan function:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Don’t forget to also import <code class="docutils literal notranslate"><span class="pre">DeviceRepository</span></code>.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># These decorators define the scan command and its arguments,</span>
<span class="c1"># including information displayed in any help message.</span>
<span class="c1"># This means the scan command is invoked via</span>
<span class="c1"># python -m &lt;project name&gt; motor start stop step detectors</span>
<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;motor&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;detectors&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span>
    <span class="n">motor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">detectors</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a scan</span>

<span class="sd">    MOTOR: Name of the motor to move</span>

<span class="sd">    START: Start position of the motor</span>

<span class="sd">    STOP: Final position of the motor</span>

<span class="sd">    STEP: Distance the motor moves at each step</span>

<span class="sd">    DETECTORS: Names of detectors that should acquire data at each point, separate</span>
<span class="sd">        by space if more than one</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># We have not yet implemented our scan logic, for now</span>
    <span class="c1"># just print out the parameters the user put in</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pretending to run a scan&quot;</span><span class="p">)</span>

    <span class="n">devices</span> <span class="o">=</span> <span class="n">DeviceRepository</span><span class="p">()</span>
    <span class="n">actual_motor</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">motor</span><span class="p">)</span>
    <span class="n">actual_detectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">detector_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">detector_name</span> <span class="ow">in</span> <span class="n">detectors</span>
    <span class="p">]</span>

    <span class="n">pprint</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;motor&quot;</span><span class="p">:</span> <span class="n">actual_motor</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
            <span class="s2">&quot;detectors&quot;</span><span class="p">:</span> <span class="n">actual_detectors</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>You will also need to create the data directory for the detector:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/data/&lt;current<span class="w"> </span>year&gt;
</pre></div>
</div>
<p>Now if you run the previous command it should connect to the detector and print out a lot more information. Remember you may have to set the EPICS ports:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">EPICS_CA_SERVER_PORT</span><span class="o">=</span><span class="m">6064</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">EPICS_CA_REPEATER_PORT</span><span class="o">=</span><span class="m">6065</span>
python<span class="w"> </span>-m<span class="w"> </span>myblueskyproject<span class="w"> </span>scan<span class="w"> </span>x<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">0</span>.1<span class="w"> </span>adsim
</pre></div>
</div>
</section>
<section id="component-3-4-the-plan-and-runengine">
<h2>Component #3 &amp; #4: The Plan and RunEngine<a class="headerlink" href="#component-3-4-the-plan-and-runengine" title="Link to this heading">#</a></h2>
<p>There is a built-in Bluesky plan for running scans. Although it doesn’t take exactly the same parameters as the GDA scan command, it is easy to wrap it in another plan that does.
Create a new file <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/src/&lt;your</span> <span class="pre">project&gt;/plans.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plans</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.protocols</span><span class="w"> </span><span class="kn">import</span> <span class="n">Movable</span><span class="p">,</span> <span class="n">Readable</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gda_style_scan</span><span class="p">(</span>
    <span class="n">motor</span><span class="p">:</span> <span class="n">Movable</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">detectors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Readable</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bluesky plan that runs a scan with similar parameters to the GDA scan command.</span>

<span class="sd">    Args:</span>
<span class="sd">        motor: Motor to move</span>
<span class="sd">        start: Start position</span>
<span class="sd">        stop: Final position</span>
<span class="sd">        step: Amount to move motor at each step</span>
<span class="sd">        detectors: Detectors that should acquire data at each step</span>

<span class="sd">    Yields:</span>
<span class="sd">        Generator: A bluesky plan that can be passed to a RunEngine</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># GDA takes the step size, bluesky takes the number of steps,</span>
    <span class="c1"># we must convert between them</span>
    <span class="n">length_of_travel</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">number_of_steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">length_of_travel</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">step</span><span class="p">)))</span>

    <span class="c1"># Actually run a scan here</span>
    <span class="k">yield from</span> <span class="n">plans</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">number_of_steps</span><span class="p">)</span>
</pre></div>
</div>
<p>The final step is to create a <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code> and pass this plan to it. Add the following imports to <code class="docutils literal notranslate"><span class="pre">&lt;your</span> <span class="pre">project&gt;/src/&lt;your</span> <span class="pre">project&gt;/__main__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">click</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunEngine</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.devices</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeviceRepository</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">gda_style_scan</span>
</pre></div>
</div>
<p>Then edit the scan function in the same file again:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># These decorators define the scan command and its arguments,</span>
<span class="c1"># including information displayed in any help message.</span>
<span class="c1"># This means the scan command is invoked via</span>
<span class="c1"># python -m &lt;project name&gt; motor start stop step detectors</span>
<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;motor&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;detectors&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span>
    <span class="n">motor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">detectors</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a scan</span>

<span class="sd">    MOTOR: Name of the motor to move</span>

<span class="sd">    START: Start position of the motor</span>

<span class="sd">    STOP: Final position of the motor</span>

<span class="sd">    STEP: Distance the motor moves at each step</span>

<span class="sd">    DETECTORS: Names of detectors that should acquire data at each point, separate</span>
<span class="sd">        by space if more than one</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running scan&quot;</span><span class="p">)</span>

    <span class="c1"># Create a run engine</span>
    <span class="n">run_engine</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">()</span>

    <span class="c1"># Create and load devices</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">DeviceRepository</span><span class="p">()</span>
    <span class="n">actual_motor</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">motor</span><span class="p">)</span>
    <span class="n">actual_detectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">detector_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">detector_name</span> <span class="ow">in</span> <span class="n">detectors</span>
    <span class="p">]</span>

    <span class="c1"># Create a sequence of instructions by applying the devices to the plan,</span>
    <span class="c1"># tell the RunEngine to execute them</span>
    <span class="n">plan_sequence</span> <span class="o">=</span> <span class="n">gda_style_scan</span><span class="p">(</span>
        <span class="n">actual_motor</span><span class="p">,</span>
        <span class="n">start</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">,</span>
        <span class="n">step</span><span class="p">,</span>
        <span class="n">actual_detectors</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">scan_id</span> <span class="o">=</span> <span class="n">run_engine</span><span class="p">(</span><span class="n">plan_sequence</span><span class="p">)</span>

    <span class="c1"># Print out the scan ID</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scan completed with ID: </span><span class="si">{</span><span class="n">scan_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now the scan should run if you run run this command, it will print out a unique scan ID at the end.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">EPICS_CA_SERVER_PORT</span><span class="o">=</span><span class="m">6064</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">EPICS_CA_REPEATER_PORT</span><span class="o">=</span><span class="m">6065</span>
python<span class="w"> </span>-m<span class="w"> </span>myblueskyproject<span class="w"> </span>scan<span class="w"> </span>x<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">0</span>.1<span class="w"> </span>adsim
</pre></div>
</div>
</section>
<section id="ideas-for-next-steps">
<h2>Ideas for Next Steps<a class="headerlink" href="#ideas-for-next-steps" title="Link to this heading">#</a></h2>
<p>And you’re done!</p>
<p>Feel free to add to your project, perhaps consulting the <a class="reference external" href="https://blueskyproject.io/bluesky">Bluesky documentation</a>.
Here are some ideas to get you started:</p>
<ul class="simple">
<li><p>Add another command, perhaps one that just takes pictures with the detector using no motors, start with the <a class="reference external" href="https://blueskyproject.io/bluesky/generated/bluesky.plans.count.html#bluesky.plans.count">count plan</a>.</p></li>
<li><p>Add some feedback via the terminal like GDA has, see <a class="reference external" href="https://blueskyproject.io/bluesky/callbacks.html">Live Visualization and Processing</a>.</p></li>
<li><p>Make the application capable of running a sequence of plans loaded from a file.</p></li>
<li><p>Add a REST API to control the application, for example using <a class="reference external" href="https://fastapi.tiangolo.com/lo/">FastAPI</a>.</p></li>
<li><p>Make the application create the directories for the detector so you don’t have to do it manually.</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="nesting.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Nest Plans</p>
      </div>
    </a>
    <a class="right-next"
       href="run-container.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Run in a container</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-a-new-project">Setting up a new project</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-libraries">Installing Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-an-example-application">Building an Example Application</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#component-1-the-command-line-interface">Component #1: The Command Line Interface</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#component-2-the-ophyd-devices">Component #2: The Ophyd Devices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#component-3-4-the-plan-and-runengine">Component #3 &amp; #4: The Plan and RunEngine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ideas-for-next-steps">Ideas for Next Steps</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/DiamondLightSource/htss-rig-bluesky/edit/main/docs/how-to/own-bluesky-project.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/how-to/own-bluesky-project.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>